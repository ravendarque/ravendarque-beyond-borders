const lt={chrome:268435456,firefox:1073676289,safari:16777216,default:16777216};function ot(){const e=navigator.userAgent.toLowerCase();return e.includes("chrome")||e.includes("edge")?"chrome":e.includes("firefox")?"firefox":e.includes("safari")&&!e.includes("chrome")?"safari":"default"}function mt(){const e=ot();return lt[e]}function ht(e,a){const t=mt(),n=e*a;if(n>t){const s=ot(),m=Math.floor(Math.sqrt(t));throw new Error(`Canvas size ${e}x${a} (${n.toLocaleString()} pixels) exceeds ${s} limit of ${Math.floor(Math.sqrt(t))}x${Math.floor(Math.sqrt(t))} (${t.toLocaleString()} pixels). Maximum dimension: ${m}px.`)}}function dt(){try{return typeof OffscreenCanvas<"u"&&typeof OffscreenCanvas.prototype.convertToBlob=="function"}catch{return!1}}function ft(e,a){if(ht(e,a),dt()){const t=new OffscreenCanvas(e,a),n=t.getContext("2d");if(!n)throw new Error("Failed to get 2D context from OffscreenCanvas");return{canvas:t,ctx:n}}else{const t=document.createElement("canvas");t.width=e,t.height=a;const n=t.getContext("2d");if(!n)throw new Error("Failed to get 2D context from Canvas");return{canvas:t,ctx:n}}}async function gt(e,a="image/png",t){return e instanceof OffscreenCanvas?e.convertToBlob({type:a,quality:t}):new Promise((n,s)=>{e.toBlob(m=>{m?n(m):s(new Error("Failed to convert canvas to blob"))},a,t)})}const Ct={HIGH_RES:1024},bt={DEFAULT_CIRCLE_SIZE:250},ut={BYTES_PER_KB:1024};class wt{startTime=0;marks=new Map;start(){this.startTime=performance.now(),this.marks.clear()}mark(a){this.marks.set(a,performance.now())}elapsed(){return performance.now()-this.startTime}duration(a,t){const n=this.marks.get(a),s=this.marks.get(t);return n===void 0||s===void 0?0:s-n}complete(a,t,n,s){const m=this.elapsed(),g=this.duration("start","imageLoaded"),u=this.duration("imageLoaded","renderComplete"),D=this.duration("renderComplete","exportComplete"),A=a.width*a.height*4,i=t.width*t.height*4,l=A+i;return{totalTime:m,imageLoadTime:g,renderTime:u,exportTime:D,inputSize:a,outputSize:t,wasDownsampled:n,downsampleRatio:s,estimatedMemory:l}}}function Mt(e,a,t,n=2){const s=t*n;if(e<=s&&a<=s)return{width:e,height:a,scale:1};const m=Math.min(s/e,s/a);return{width:Math.round(e*m),height:Math.round(a*m),scale:m}}async function xt(e,a,t){if(e.width===a&&e.height===t)return e;const n=new OffscreenCanvas(a,t),s=n.getContext("2d");if(!s)throw new Error("Failed to get 2D context for downsampling");return s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.drawImage(e,0,0,a,t),createImageBitmap(n)}function It(e,a,t,n=2){return Math.max(e,a)>t*n}async function yt(e,a,t){const n=new wt,s=t.enablePerformanceTracking??!1;s&&(n.start(),n.mark("start"));const m=t.enableDownsampling??!0;let g=e,u=!1,D=1;if(m&&It(e.width,e.height,t.size)){const c=Mt(e.width,e.height,t.size);g=await xt(e,c.width,c.height),u=!0,D=c.scale,s&&n.mark("imageDownsampled")}s&&n.mark("imageLoaded"),t.onProgress?.(.2);const A=t.size,i=A,l=A,J=Math.min(i,l),Q=Math.round(t.thicknessPct/100*J),U=Math.round((t.paddingPct??0)/100*J),{canvas:q,ctx:o}=ft(i,l);o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",t.backgroundColor&&(o.save(),o.fillStyle=t.backgroundColor,o.fillRect(0,0,i,l),o.restore());const d=Math.min(i,l)/2,M=d-Math.max(1,U),C=Math.max(0,M-Q),X=Pt(C,0,d-.5),p=(a.modes?.ring?.colors??[]).map(c=>({color:c,weight:1})),E=p.length,B=t.presentation;let f;if(B==="ring"?f="concentric":B==="segment"?f="angular":B==="cutout"?f="cutout":f="concentric",f==="cutout"){o.save(),o.beginPath(),o.arc(d,d,X,0,Math.PI*2),o.closePath(),o.clip();const c=g.width,v=g.height,$=X*2,R=Math.max($/c,$/v),k=t.imageZoom??0;console.log("[renderer CUTOUT] imageZoom received:",t.imageZoom,"zoom value:",k,"coverScale:",R);const L=1+k/100,x=R*L;console.log("[renderer CUTOUT] zoomMultiplier:",L,"final scale:",x,"dw:",c*x,"dh:",v*x);const F=c*x,w=v*x,K=t.imageOffsetPx?.x??0,Y=t.imageOffsetPx?.y??0,_=i/2+K,G=l/2+Y;o.drawImage(g,_-F/2,G-w/2,F,w),o.restore(),t.onProgress?.(.4);const O=t.flagOffsetPct?.x??0,z=i,y=Math.abs(O/50)*z*3,h=new OffscreenCanvas(i+y,l),r=h.getContext("2d");r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high";const S=y/2+d;if(t.borderImageBitmap){const T=M*2,P=T,W=a.aspectRatio??2,I=P*W,V=(I-T)/2,j=-(O/50)*V,tt=S-I/2+j,et=d-P/2;r.drawImage(t.borderImageBitmap,tt,et,I,P)}else{let T=0;for(const P of p){const I=P.weight/E*l;r.fillStyle=P.color,r.fillRect(0,T,h.width,I),T+=I}}r.globalCompositeOperation="destination-in",r.fillStyle="white",r.beginPath(),r.arc(S,d,M,0,Math.PI*2),r.arc(S,d,C,Math.PI*2,0,!0),r.fill(),o.drawImage(h,-y/2,0)}else{o.save(),o.beginPath(),o.arc(d,d,X,0,Math.PI*2),o.closePath(),o.clip();const c=g.width,v=g.height,$=X*2,R=Math.max($/c,$/v),k=t.imageZoom??0;console.log("[renderer] imageZoom received:",t.imageZoom,"zoom value:",k,"coverScale:",R);const L=1+k/100,x=R*L;console.log("[renderer] zoomMultiplier:",L,"final scale:",x,"dw:",c*x,"dh:",v*x);const F=c*x,w=v*x,K=t.imageOffsetPx?.x??0,Y=t.imageOffsetPx?.y??0,_=i/2+K,G=l/2+Y;if(o.drawImage(g,_-F/2,G-w/2,F,w),o.restore(),t.onProgress?.(.5),t.borderImageBitmap&&B!=="cutout"){const O=Math.max(1,Math.round(M-C)),z=(C+M)/2,h=Math.max(2,Math.round(2*Math.PI*z)),r=O;try{const S=new OffscreenCanvas(h,r),T=S.getContext("2d"),P=t.borderImageBitmap.width,W=t.borderImageBitmap.height,I=Math.max(h/P,r/W),V=Math.round(P*I),j=Math.round(W*I),tt=Math.round((h-V)/2),et=Math.round((r-j)/2);T.clearRect(0,0,h,r),T.drawImage(t.borderImageBitmap,0,0,P,W,tt,et,V,j);const rt=await createImageBitmap(S),ct=t.segmentRotation!==void 0?t.segmentRotation*Math.PI/180:0,it=-Math.PI/2+ct;nt(o,d,C,M,rt,it,"normal")}catch{try{nt(o,d,C,M,t.borderImageBitmap)}catch{o.save(),o.globalAlpha=.64,at(o,d,C,M,p,E),o.restore()}}}else if(f==="concentric")at(o,d,C,M,p,E);else{const O=t.segmentRotation!==void 0?t.segmentRotation*Math.PI/180:0;let z=-Math.PI/2+O;for(const y of p){const h=y.weight/E,r=Math.PI*2*h,S=z+r;vt(o,d,C,M,z,S,y.color),z=S}}}s&&n.mark("renderComplete"),t.onProgress?.(.8),t.outerStroke&&(o.beginPath(),o.arc(i/2,l/2,M,0,Math.PI*2),o.strokeStyle=t.outerStroke.color,o.lineWidth=t.outerStroke.widthPx,o.stroke());const b=t.pngQuality??.92,H=await gt(q,"image/png",b),Z=H.size,N=(Z/ut.BYTES_PER_KB).toFixed(2);if(s){n.mark("exportComplete");const c=n.complete({width:e.width,height:e.height},{width:i,height:l},u,D);return t.onProgress?.(1),{blob:H,sizeBytes:Z,sizeKB:N,metrics:c}}return t.onProgress?.(1),{blob:H,sizeBytes:Z,sizeKB:N}}function at(e,a,t,n,s,m){const g=n-t;let u=n;for(const D of s){const i=D.weight/m*g,l=Math.max(t,u-i);if(e.beginPath(),e.arc(a,a,u,0,Math.PI*2),e.arc(a,a,l,Math.PI*2,0,!0),e.closePath(),e.fillStyle=D.color,e.fill(),u=l,u<=t+.5)break}u>t+.5&&(e.beginPath(),e.arc(a,a,u,0,Math.PI*2),e.arc(a,a,t,Math.PI*2,0,!0),e.closePath(),e.fillStyle=s[s.length-1]?.color??"#000000",e.fill())}function vt(e,a,t,n,s,m,g){e.beginPath(),e.arc(a,a,n,s,m),e.arc(a,a,t,m,s,!0),e.closePath(),e.fillStyle=g,e.fill()}function Pt(e,a,t){return Math.min(Math.max(e,a),t)}function nt(e,a,t,n,s,m=0,g="normal"){const u=n-t;if(u<=0)return;const D=(t+n)/2,A=Math.max(1,Math.round(2*Math.PI*D)),i=Math.max(1,A),l=Math.max(1,Math.round(u)),Q=new OffscreenCanvas(i,l).getContext("2d"),U=s.width,q=s.height,o=Math.max(i/U,l/q),d=Math.round(U*o),M=Math.round(q*o),C=Math.round((i-d)/2),X=Math.round((l-M)/2);Q.clearRect(0,0,i,l),Q.drawImage(s,0,0,U,q,C,X,d,M);const p=Q.getImageData(0,0,i,l).data,E=Math.floor(a-n),B=Math.floor(a-n),f=Math.ceil(n*2),b=f,H=new OffscreenCanvas(f,b),Z=H.getContext("2d"),N=Z.createImageData(f,b),c=N.data,v=Math.PI*2,$=1/v;for(let w=0;w<b;w++){const Y=B+w+.5-a;for(let _=0;_<f;_++){const O=E+_+.5-a,z=O*O+Y*Y,y=Math.sqrt(z),h=(w*f+_)*4;if(y<t||y>n){c[h+0]=0,c[h+1]=0,c[h+2]=0,c[h+3]=0;continue}let r=Math.atan2(Y,O);for(r-=m;r<0;)r+=v;for(;r>=v;)r-=v;const S=r*$*i,T=(y-t)/u*l,P=Math.min(i-1,Math.max(0,Math.floor(S))),I=(Math.min(l-1,Math.max(0,Math.floor(T)))*i+P)*4;c[h+0]=p[I+0],c[h+1]=p[I+1],c[h+2]=p[I+2],c[h+3]=p[I+3]}}if(Z.putImageData(N,0,0),g==="normal"){e.save(),e.drawImage(H,E,B),e.restore();return}const R=new OffscreenCanvas(f,b),k=R.getContext("2d");k.clearRect(0,0,f,b),k.drawImage(e.canvas,E,B,f,b,0,0,f,b);const L=k.getImageData(0,0,f,b),x=L.data,F=Z.getImageData(0,0,f,b).data;for(let w=0;w<x.length;w+=4)F[w+3]>8&&(x[w+3]=0);k.putImageData(L,0,0),e.save(),e.drawImage(R,E,B),e.restore()}export{bt as I,Ct as R,yt as r};
