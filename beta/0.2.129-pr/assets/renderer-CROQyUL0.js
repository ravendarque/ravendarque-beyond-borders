const ct={chrome:268435456,firefox:1073676289,safari:16777216,default:16777216};function at(){const e=navigator.userAgent.toLowerCase();return e.includes("chrome")||e.includes("edge")?"chrome":e.includes("firefox")?"firefox":e.includes("safari")&&!e.includes("chrome")?"safari":"default"}function it(){const e=at();return ct[e]}function lt(e,a){const t=it(),n=e*a;if(n>t){const s=at(),i=Math.floor(Math.sqrt(t));throw new Error(`Canvas size ${e}x${a} (${n.toLocaleString()} pixels) exceeds ${s} limit of ${Math.floor(Math.sqrt(t))}x${Math.floor(Math.sqrt(t))} (${t.toLocaleString()} pixels). Maximum dimension: ${i}px.`)}}function ht(){try{return typeof OffscreenCanvas<"u"&&typeof OffscreenCanvas.prototype.convertToBlob=="function"}catch{return!1}}function ft(e,a){if(lt(e,a),ht()){const t=new OffscreenCanvas(e,a),n=t.getContext("2d");if(!n)throw new Error("Failed to get 2D context from OffscreenCanvas");return{canvas:t,ctx:n}}else{const t=document.createElement("canvas");t.width=e,t.height=a;const n=t.getContext("2d");if(!n)throw new Error("Failed to get 2D context from Canvas");return{canvas:t,ctx:n}}}async function dt(e,a="image/png",t){return e instanceof OffscreenCanvas?e.convertToBlob({type:a,quality:t}):new Promise((n,s)=>{e.toBlob(i=>{i?n(i):s(new Error("Failed to convert canvas to blob"))},a,t)})}class mt{startTime=0;marks=new Map;start(){this.startTime=performance.now(),this.marks.clear()}mark(a){this.marks.set(a,performance.now())}elapsed(){return performance.now()-this.startTime}duration(a,t){const n=this.marks.get(a),s=this.marks.get(t);return n===void 0||s===void 0?0:s-n}complete(a,t,n,s){const i=this.elapsed(),x=this.duration("start","imageLoaded"),I=this.duration("imageLoaded","renderComplete"),S=this.duration("renderComplete","exportComplete"),$=a.width*a.height*4,c=t.width*t.height*4,r=$+c;return{totalTime:i,imageLoadTime:x,renderTime:I,exportTime:S,inputSize:a,outputSize:t,wasDownsampled:n,downsampleRatio:s,estimatedMemory:r}}}function gt(e,a,t,n=2){const s=t*n;if(e<=s&&a<=s)return{width:e,height:a,scale:1};const i=Math.min(s/e,s/a);return{width:Math.round(e*i),height:Math.round(a*i),scale:i}}async function ut(e,a,t){if(e.width===a&&e.height===t)return e;const n=new OffscreenCanvas(a,t),s=n.getContext("2d");if(!s)throw new Error("Failed to get 2D context for downsampling");return s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.drawImage(e,0,0,a,t),createImageBitmap(n)}function wt(e,a,t,n=2){return Math.max(e,a)>t*n}async function It(e,a,t){const n=new mt,s=t.enablePerformanceTracking??!1;s&&(n.start(),n.mark("start"));const i=t.enableDownsampling??!0;let x=e,I=!1,S=1;if(i&&wt(e.width,e.height,t.size)){const h=gt(e.width,e.height,t.size);x=await ut(e,h.width,h.height),I=!0,S=h.scale,s&&n.mark("imageDownsampled")}s&&n.mark("imageLoaded"),t.onProgress?.(.2);const $=t.size,c=$,r=$,J=Math.min(c,r),K=Math.round(t.thicknessPct/100*J),N=Math.round((t.paddingPct??0)/100*J),{canvas:V,ctx:o}=ft(c,r);t.backgroundColor&&(o.save(),o.fillStyle=t.backgroundColor,o.fillRect(0,0,c,r),o.restore());const l=Math.min(c,r)/2,g=l-Math.max(1,N),y=Math.max(0,g-K),U=t.imageInsetPx??0,_=xt(y-U,0,l-.5),D=(a.modes?.ring?.colors??[]).map(h=>({color:h,weight:1})),B=D.length,u=t.presentation;let w;if(u==="ring"?w="concentric":u==="segment"?w="angular":u==="cutout"?w="cutout":w="concentric",w==="cutout"){o.save(),o.beginPath(),o.arc(l,l,_,0,Math.PI*2),o.closePath(),o.clip();const h=x.width,W=x.height,z=_*2,O=Math.max(z/h,z/W),E=h*O,L=W*O,Y=c/2,P=r/2;o.drawImage(x,Y-E/2,P-L/2,E,L),o.restore(),t.onProgress?.(.4);const H=t.flagOffsetPx?.x??t.imageOffsetPx?.x??0,T=Math.abs(H)*3,v=new OffscreenCanvas(c+T,r),M=v.getContext("2d"),b=T/2+l;if(t.borderImageBitmap){const f=g*2,d=a.aspectRatio??2,m=f*d;let k=b-m/2-H;const X=l-f/2,F=b-g,Q=b+g,R=k,Z=k+m;R>F&&(k=F),Z<Q&&(k=Q-m),M.drawImage(t.borderImageBitmap,k,X,m,f)}else{let C=0;for(const f of D){const m=f.weight/B*r;M.fillStyle=f.color,M.fillRect(0,C,v.width,m),C+=m}}M.globalCompositeOperation="destination-in",M.fillStyle="white",M.beginPath(),M.arc(b,l,g,0,Math.PI*2),M.arc(b,l,y,Math.PI*2,0,!0),M.fill(),o.drawImage(v,-T/2,0)}else{o.save(),o.beginPath();const h=t.imageOffsetPx?.x??0,W=t.imageOffsetPx?.y??0;o.arc(l+h,l+W,_,0,Math.PI*2),o.closePath(),o.clip();const z=x.width,O=x.height,E=_*2,L=Math.max(E/z,E/O),Y=z*L,P=O*L,H=c/2+h,T=r/2+W;if(o.drawImage(x,H-Y/2,T-P/2,Y,P),o.restore(),t.onProgress?.(.5),t.borderImageBitmap&&u!=="cutout"){const v=Math.max(1,Math.round(g-y)),M=(y+g)/2,C=Math.max(2,Math.round(2*Math.PI*M)),f=v;try{const d=new OffscreenCanvas(C,f),m=d.getContext("2d"),k=t.borderImageBitmap.width,X=t.borderImageBitmap.height,F=Math.max(C/k,f/X),Q=Math.round(k*F),R=Math.round(X*F),Z=Math.round((C-Q)/2),nt=Math.round((f-R)/2);m.clearRect(0,0,C,f),m.drawImage(t.borderImageBitmap,0,0,k,X,Z,nt,Q,R);const st=await createImageBitmap(d),ot=t.segmentRotation!==void 0?t.segmentRotation*Math.PI/180:0,rt=-Math.PI/2+ot;et(o,l,y,g,st,rt,"normal")}catch{try{et(o,l,y,g,t.borderImageBitmap)}catch{o.save(),o.globalAlpha=.64,tt(o,l,y,g,D,B),o.restore()}}}else if(w==="concentric")tt(o,l,y,g,D,B);else{const v=t.segmentRotation!==void 0?t.segmentRotation*Math.PI/180:0;let M=-Math.PI/2+v;for(const b of D){const C=b.weight/B,f=Math.PI*2*C,d=M+f;Mt(o,l,y,g,M,d,b.color),M=d}}}s&&n.mark("renderComplete"),t.onProgress?.(.8),t.outerStroke&&(o.beginPath(),o.arc(c/2,r/2,g,0,Math.PI*2),o.strokeStyle=t.outerStroke.color,o.lineWidth=t.outerStroke.widthPx,o.stroke());const G=t.pngQuality??.92,A=await dt(V,"image/png",G),q=A.size,p=(q/1024).toFixed(2);if(s){n.mark("exportComplete");const h=n.complete({width:e.width,height:e.height},{width:c,height:r},I,S);return t.onProgress?.(1),{blob:A,sizeBytes:q,sizeKB:p,metrics:h}}return t.onProgress?.(1),{blob:A,sizeBytes:q,sizeKB:p}}function tt(e,a,t,n,s,i){const x=n-t;let I=n;for(const S of s){const c=S.weight/i*x,r=Math.max(t,I-c);if(e.beginPath(),e.arc(a,a,I,0,Math.PI*2),e.arc(a,a,r,Math.PI*2,0,!0),e.closePath(),e.fillStyle=S.color,e.fill(),I=r,I<=t+.5)break}I>t+.5&&(e.beginPath(),e.arc(a,a,I,0,Math.PI*2),e.arc(a,a,t,Math.PI*2,0,!0),e.closePath(),e.fillStyle=s[s.length-1]?.color??"#000000",e.fill())}function Mt(e,a,t,n,s,i,x){e.beginPath(),e.arc(a,a,n,s,i),e.arc(a,a,t,i,s,!0),e.closePath(),e.fillStyle=x,e.fill()}function xt(e,a,t){return Math.min(Math.max(e,a),t)}function et(e,a,t,n,s,i=0,x="normal"){const I=n-t;if(I<=0)return;const S=(t+n)/2,$=Math.max(1,Math.round(2*Math.PI*S)),c=Math.max(1,$),r=Math.max(1,Math.round(I)),K=new OffscreenCanvas(c,r).getContext("2d"),N=s.width,V=s.height,o=Math.max(c/N,r/V),l=Math.round(N*o),g=Math.round(V*o),y=Math.round((c-l)/2),U=Math.round((r-g)/2);K.clearRect(0,0,c,r),K.drawImage(s,0,0,N,V,y,U,l,g);const j=K.getImageData(0,0,c,r).data,D=Math.floor(a-n),B=Math.floor(a-n),u=Math.ceil(n*2),w=u,G=new OffscreenCanvas(u,w),A=G.getContext("2d"),q=A.createImageData(u,w),p=q.data,h=Math.PI*2,W=1/h;for(let P=0;P<w;P++){const T=B+P+.5-a;for(let v=0;v<u;v++){const b=D+v+.5-a,C=b*b+T*T,f=Math.sqrt(C),d=(P*u+v)*4;if(f<t||f>n){p[d+0]=0,p[d+1]=0,p[d+2]=0,p[d+3]=0;continue}let m=Math.atan2(T,b);for(m-=i;m<0;)m+=h;for(;m>=h;)m-=h;const k=m*W*c,X=(f-t)/I*r,F=Math.min(c-1,Math.max(0,Math.floor(k))),R=(Math.min(r-1,Math.max(0,Math.floor(X)))*c+F)*4;p[d+0]=j[R+0],p[d+1]=j[R+1],p[d+2]=j[R+2],p[d+3]=j[R+3]}}if(A.putImageData(q,0,0),x==="normal"){e.save(),e.drawImage(G,D,B),e.restore();return}const z=new OffscreenCanvas(u,w),O=z.getContext("2d");O.clearRect(0,0,u,w),O.drawImage(e.canvas,D,B,u,w,0,0,u,w);const E=O.getImageData(0,0,u,w),L=E.data,Y=A.getImageData(0,0,u,w).data;for(let P=0;P<L.length;P+=4)Y[P+3]>8&&(L[P+3]=0);O.putImageData(E,0,0),e.save(),e.drawImage(z,D,B),e.restore()}export{It as r};
