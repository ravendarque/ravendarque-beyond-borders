const lt={chrome:268435456,firefox:1073676289,safari:16777216,default:16777216};function ot(){const e=navigator.userAgent.toLowerCase();return e.includes("chrome")||e.includes("edge")?"chrome":e.includes("firefox")?"firefox":e.includes("safari")&&!e.includes("chrome")?"safari":"default"}function mt(){const e=ot();return lt[e]}function dt(e,a){const t=mt(),n=e*a;if(n>t){const s=ot(),m=Math.floor(Math.sqrt(t));throw new Error(`Canvas size ${e}x${a} (${n.toLocaleString()} pixels) exceeds ${s} limit of ${Math.floor(Math.sqrt(t))}x${Math.floor(Math.sqrt(t))} (${t.toLocaleString()} pixels). Maximum dimension: ${m}px.`)}}function ht(){try{return typeof OffscreenCanvas<"u"&&typeof OffscreenCanvas.prototype.convertToBlob=="function"}catch{return!1}}function ft(e,a){if(dt(e,a),ht()){const t=new OffscreenCanvas(e,a),n=t.getContext("2d");if(!n)throw new Error("Failed to get 2D context from OffscreenCanvas");return{canvas:t,ctx:n}}else{const t=document.createElement("canvas");t.width=e,t.height=a;const n=t.getContext("2d");if(!n)throw new Error("Failed to get 2D context from Canvas");return{canvas:t,ctx:n}}}async function gt(e,a="image/png",t){return e instanceof OffscreenCanvas?e.convertToBlob({type:a,quality:t}):new Promise((n,s)=>{e.toBlob(m=>{m?n(m):s(new Error("Failed to convert canvas to blob"))},a,t)})}const Ct={HIGH_RES:1024},bt={DEFAULT_CIRCLE_SIZE:250},ut={BYTES_PER_KB:1024};class Mt{startTime=0;marks=new Map;start(){this.startTime=performance.now(),this.marks.clear()}mark(a){this.marks.set(a,performance.now())}elapsed(){return performance.now()-this.startTime}duration(a,t){const n=this.marks.get(a),s=this.marks.get(t);return n===void 0||s===void 0?0:s-n}complete(a,t,n,s){const m=this.elapsed(),M=this.duration("start","imageLoaded"),u=this.duration("imageLoaded","renderComplete"),D=this.duration("renderComplete","exportComplete"),Z=a.width*a.height*4,i=t.width*t.height*4,l=Z+i;return{totalTime:m,imageLoadTime:M,renderTime:u,exportTime:D,inputSize:a,outputSize:t,wasDownsampled:n,downsampleRatio:s,estimatedMemory:l}}}function wt(e,a,t,n=2){const s=t*n;if(e<=s&&a<=s)return{width:e,height:a,scale:1};const m=Math.min(s/e,s/a);return{width:Math.round(e*m),height:Math.round(a*m),scale:m}}async function xt(e,a,t){if(e.width===a&&e.height===t)return e;const n=new OffscreenCanvas(a,t),s=n.getContext("2d");if(!s)throw new Error("Failed to get 2D context for downsampling");return s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.drawImage(e,0,0,a,t),createImageBitmap(n)}function It(e,a,t,n=2){return Math.max(e,a)>t*n}async function St(e,a,t){const n=new Mt,s=t.enablePerformanceTracking??!1;s&&(n.start(),n.mark("start"));const m=t.enableDownsampling??!0;let M=e,u=!1,D=1;if(m&&It(e.width,e.height,t.size)){const c=wt(e.width,e.height,t.size);M=await xt(e,c.width,c.height),u=!0,D=c.scale,s&&n.mark("imageDownsampled")}s&&n.mark("imageLoaded"),t.onProgress?.(.2);const Z=t.size,i=Z,l=Z,J=Math.min(i,l),H=Math.round(t.thicknessPct/100*J),Q=Math.round((t.paddingPct??0)/100*J),{canvas:U,ctx:o}=ft(i,l);o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",t.backgroundColor&&(o.save(),o.fillStyle=t.backgroundColor,o.fillRect(0,0,i,l),o.restore());const h=Math.min(i,l)/2,w=h-Math.max(1,Q),C=Math.max(0,w-H),$=vt(C,0,h-.5),y=(a.modes?.ring?.colors??[]).map(c=>({color:c,weight:1})),R=y.length,B=t.presentation;let f;if(B==="ring"?f="concentric":B==="segment"?f="angular":B==="cutout"?f="cutout":f="concentric",f==="cutout"){o.save(),o.beginPath(),o.arc(h,h,$,0,Math.PI*2),o.closePath(),o.clip();const c=M.width,I=M.height,G=$*2,L=Math.max(G/c,G/I),T=t.imageZoom??0;console.log("[renderer CUTOUT] imageZoom received:",t.imageZoom,"zoom value:",T,"coverScale:",L);const _=1+T/100,P=L*_;console.log("[renderer CUTOUT] zoomMultiplier:",_,"final scale:",P,"dw:",c*P,"dh:",I*P);const p=c*P,g=I*P,X=t.imageOffsetPx?.x??0,A=t.imageOffsetPx?.y??0,z=i/2+X,K=l/2+A;o.drawImage(M,z-p/2,K-g/2,p,g),o.restore(),t.onProgress?.(.4);const O=t.flagOffsetPct?.x??0,N=i,S=Math.abs(O/50)*N*3,d=new OffscreenCanvas(i+S,l),r=d.getContext("2d");r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high";const E=S/2+h;if(t.borderImageBitmap){const k=w*2,v=k,Y=a.aspectRatio??2,x=v*Y,V=(x-k)/2,j=-(O/50)*V,tt=E-x/2+j,et=h-v/2;r.drawImage(t.borderImageBitmap,tt,et,x,v)}else{let k=0;for(const v of y){const x=v.weight/R*l;r.fillStyle=v.color,r.fillRect(0,k,d.width,x),k+=x}}r.globalCompositeOperation="destination-in",r.fillStyle="white",r.beginPath(),r.arc(E,h,w,0,Math.PI*2),r.arc(E,h,C,Math.PI*2,0,!0),r.fill(),o.drawImage(d,-S/2,0)}else{o.save(),o.beginPath(),o.arc(h,h,$,0,Math.PI*2),o.closePath(),o.clip();const c=M.width,I=M.height,G=$*2,L=Math.max(G/c,G/I),T=t.imageZoom??0;console.log("[renderer RING/SEGMENT] Original image:",e.width,"x",e.height),console.log("[renderer RING/SEGMENT] Processed image:",c,"x",I,"wasDownsampled:",u),console.log("[renderer RING/SEGMENT] imageRadius:",$,"target:",G),console.log("[renderer RING/SEGMENT] imageZoom received:",t.imageZoom,"zoom value:",T,"coverScale:",L);const _=1+T/100,P=L*_,p=c*P,g=I*P;console.log("[renderer RING/SEGMENT] zoomMultiplier:",_,"final scale:",P,"dw:",p,"dh:",g);const X=t.imageOffsetPx?.x??0,A=t.imageOffsetPx?.y??0;console.log("[renderer RING/SEGMENT] imageOffset:",X,A);const z=i/2+X,K=l/2+A;if(console.log("[renderer RING/SEGMENT] Drawing at:",z-p/2,K-g/2,"size:",p,g),o.drawImage(M,z-p/2,K-g/2,p,g),o.restore(),t.onProgress?.(.5),t.borderImageBitmap&&B!=="cutout"){const O=Math.max(1,Math.round(w-C)),N=(C+w)/2,d=Math.max(2,Math.round(2*Math.PI*N)),r=O;try{const E=new OffscreenCanvas(d,r),k=E.getContext("2d"),v=t.borderImageBitmap.width,Y=t.borderImageBitmap.height,x=Math.max(d/v,r/Y),V=Math.round(v*x),j=Math.round(Y*x),tt=Math.round((d-V)/2),et=Math.round((r-j)/2);k.clearRect(0,0,d,r),k.drawImage(t.borderImageBitmap,0,0,v,Y,tt,et,V,j);const rt=await createImageBitmap(E),ct=t.segmentRotation!==void 0?t.segmentRotation*Math.PI/180:0,it=-Math.PI/2+ct;nt(o,h,C,w,rt,it,"normal")}catch{try{nt(o,h,C,w,t.borderImageBitmap)}catch{o.save(),o.globalAlpha=.64,at(o,h,C,w,y,R),o.restore()}}}else if(f==="concentric")at(o,h,C,w,y,R);else{const O=t.segmentRotation!==void 0?t.segmentRotation*Math.PI/180:0;let N=-Math.PI/2+O;for(const S of y){const d=S.weight/R,r=Math.PI*2*d,E=N+r;Pt(o,h,C,w,N,E,S.color),N=E}}}s&&n.mark("renderComplete"),t.onProgress?.(.8),t.outerStroke&&(o.beginPath(),o.arc(i/2,l/2,w,0,Math.PI*2),o.strokeStyle=t.outerStroke.color,o.lineWidth=t.outerStroke.widthPx,o.stroke());const b=t.pngQuality??.92,W=await gt(U,"image/png",b),F=W.size,q=(F/ut.BYTES_PER_KB).toFixed(2);if(s){n.mark("exportComplete");const c=n.complete({width:e.width,height:e.height},{width:i,height:l},u,D);return t.onProgress?.(1),{blob:W,sizeBytes:F,sizeKB:q,metrics:c}}return t.onProgress?.(1),{blob:W,sizeBytes:F,sizeKB:q}}function at(e,a,t,n,s,m){const M=n-t;let u=n;for(const D of s){const i=D.weight/m*M,l=Math.max(t,u-i);if(e.beginPath(),e.arc(a,a,u,0,Math.PI*2),e.arc(a,a,l,Math.PI*2,0,!0),e.closePath(),e.fillStyle=D.color,e.fill(),u=l,u<=t+.5)break}u>t+.5&&(e.beginPath(),e.arc(a,a,u,0,Math.PI*2),e.arc(a,a,t,Math.PI*2,0,!0),e.closePath(),e.fillStyle=s[s.length-1]?.color??"#000000",e.fill())}function Pt(e,a,t,n,s,m,M){e.beginPath(),e.arc(a,a,n,s,m),e.arc(a,a,t,m,s,!0),e.closePath(),e.fillStyle=M,e.fill()}function vt(e,a,t){return Math.min(Math.max(e,a),t)}function nt(e,a,t,n,s,m=0,M="normal"){const u=n-t;if(u<=0)return;const D=(t+n)/2,Z=Math.max(1,Math.round(2*Math.PI*D)),i=Math.max(1,Z),l=Math.max(1,Math.round(u)),H=new OffscreenCanvas(i,l).getContext("2d"),Q=s.width,U=s.height,o=Math.max(i/Q,l/U),h=Math.round(Q*o),w=Math.round(U*o),C=Math.round((i-h)/2),$=Math.round((l-w)/2);H.clearRect(0,0,i,l),H.drawImage(s,0,0,Q,U,C,$,h,w);const y=H.getImageData(0,0,i,l).data,R=Math.floor(a-n),B=Math.floor(a-n),f=Math.ceil(n*2),b=f,W=new OffscreenCanvas(f,b),F=W.getContext("2d"),q=F.createImageData(f,b),c=q.data,I=Math.PI*2,G=1/I;for(let g=0;g<b;g++){const A=B+g+.5-a;for(let z=0;z<f;z++){const O=R+z+.5-a,N=O*O+A*A,S=Math.sqrt(N),d=(g*f+z)*4;if(S<t||S>n){c[d+0]=0,c[d+1]=0,c[d+2]=0,c[d+3]=0;continue}let r=Math.atan2(A,O);for(r-=m;r<0;)r+=I;for(;r>=I;)r-=I;const E=r*G*i,k=(S-t)/u*l,v=Math.min(i-1,Math.max(0,Math.floor(E))),x=(Math.min(l-1,Math.max(0,Math.floor(k)))*i+v)*4;c[d+0]=y[x+0],c[d+1]=y[x+1],c[d+2]=y[x+2],c[d+3]=y[x+3]}}if(F.putImageData(q,0,0),M==="normal"){e.save(),e.drawImage(W,R,B),e.restore();return}const L=new OffscreenCanvas(f,b),T=L.getContext("2d");T.clearRect(0,0,f,b),T.drawImage(e.canvas,R,B,f,b,0,0,f,b);const _=T.getImageData(0,0,f,b),P=_.data,p=F.getImageData(0,0,f,b).data;for(let g=0;g<P.length;g+=4)p[g+3]>8&&(P[g+3]=0);T.putImageData(_,0,0),e.save(),e.drawImage(L,R,B),e.restore()}export{bt as I,Ct as R,St as r};
