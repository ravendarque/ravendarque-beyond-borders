const ct={chrome:268435456,firefox:1073676289,safari:16777216,default:16777216};function et(){const e=navigator.userAgent.toLowerCase();return e.includes("chrome")||e.includes("edge")?"chrome":e.includes("firefox")?"firefox":e.includes("safari")&&!e.includes("chrome")?"safari":"default"}function it(){const e=et();return ct[e]}function lt(e,a){const t=it(),n=e*a;if(n>t){const s=et(),i=Math.floor(Math.sqrt(t));throw new Error(`Canvas size ${e}x${a} (${n.toLocaleString()} pixels) exceeds ${s} limit of ${Math.floor(Math.sqrt(t))}x${Math.floor(Math.sqrt(t))} (${t.toLocaleString()} pixels). Maximum dimension: ${i}px.`)}}function ht(){try{return typeof OffscreenCanvas<"u"&&typeof OffscreenCanvas.prototype.convertToBlob=="function"}catch{return!1}}function mt(e,a){if(lt(e,a),ht()){const t=new OffscreenCanvas(e,a),n=t.getContext("2d");if(!n)throw new Error("Failed to get 2D context from OffscreenCanvas");return{canvas:t,ctx:n}}else{const t=document.createElement("canvas");t.width=e,t.height=a;const n=t.getContext("2d");if(!n)throw new Error("Failed to get 2D context from Canvas");return{canvas:t,ctx:n}}}async function ft(e,a="image/png",t){return e instanceof OffscreenCanvas?e.convertToBlob({type:a,quality:t}):new Promise((n,s)=>{e.toBlob(i=>{i?n(i):s(new Error("Failed to convert canvas to blob"))},a,t)})}class dt{startTime=0;marks=new Map;start(){this.startTime=performance.now(),this.marks.clear()}mark(a){this.marks.set(a,performance.now())}elapsed(){return performance.now()-this.startTime}duration(a,t){const n=this.marks.get(a),s=this.marks.get(t);return n===void 0||s===void 0?0:s-n}complete(a,t,n,s){const i=this.elapsed(),M=this.duration("start","imageLoaded"),x=this.duration("imageLoaded","renderComplete"),D=this.duration("renderComplete","exportComplete"),E=a.width*a.height*4,c=t.width*t.height*4,r=E+c;return{totalTime:i,imageLoadTime:M,renderTime:x,exportTime:D,inputSize:a,outputSize:t,wasDownsampled:n,downsampleRatio:s,estimatedMemory:r}}}function gt(e,a,t,n=2){const s=t*n;if(e<=s&&a<=s)return{width:e,height:a,scale:1};const i=Math.min(s/e,s/a);return{width:Math.round(e*i),height:Math.round(a*i),scale:i}}async function ut(e,a,t){if(e.width===a&&e.height===t)return e;const n=new OffscreenCanvas(a,t),s=n.getContext("2d");if(!s)throw new Error("Failed to get 2D context for downsampling");return s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.drawImage(e,0,0,a,t),createImageBitmap(n)}function wt(e,a,t,n=2){return Math.max(e,a)>t*n}async function It(e,a,t){const n=new dt,s=t.enablePerformanceTracking??!1;s&&(n.start(),n.mark("start"));const i=t.enableDownsampling??!0;let M=e,x=!1,D=1;if(i&&wt(e.width,e.height,t.size)){const h=gt(e.width,e.height,t.size);M=await ut(e,h.width,h.height),x=!0,D=h.scale,s&&n.mark("imageDownsampled")}s&&n.mark("imageLoaded"),t.onProgress?.(.2);const E=t.size,c=E,r=E,J=Math.min(c,r),H=Math.round(t.thicknessPct/100*J),K=Math.round((t.paddingPct??0)/100*J),{canvas:N,ctx:o}=mt(c,r);o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",t.backgroundColor&&(o.save(),o.fillStyle=t.backgroundColor,o.fillRect(0,0,c,r),o.restore());const l=Math.min(c,r)/2,I=l-Math.max(1,K),C=Math.max(0,I-H),U=t.imageInsetPx??0,V=xt(C-U,0,l-.5),k=(a.modes?.ring?.colors??[]).map(h=>({color:h,weight:1})),O=k.length,g=t.presentation;let u;if(g==="ring"?u="concentric":g==="segment"?u="angular":g==="cutout"?u="cutout":u="concentric",u==="cutout"){o.save(),o.beginPath(),o.arc(l,l,V,0,Math.PI*2),o.closePath(),o.clip();const h=M.width,$=M.height,T=V*2,S=Math.max(T/h,T/$),z=h*S,R=$*S,Q=c/2,P=r/2;o.drawImage(M,Q-z/2,P-R/2,z,R),o.restore(),t.onProgress?.(.4);const q=t.flagOffsetPx?.x??t.imageOffsetPx?.x??0,B=Math.abs(q)*3,v=new OffscreenCanvas(c+B,r),m=v.getContext("2d");m.imageSmoothingEnabled=!0,m.imageSmoothingQuality="high";const p=B/2+l;if(t.borderImageBitmap){const b=I*2,f=b,d=a.aspectRatio??2,w=f*d,A=(w-b)/2,W=q/256*A,Y=p-w/2+W,j=l-f/2;m.drawImage(t.borderImageBitmap,Y,j,w,f)}else{let b=0;for(const f of k){const w=f.weight/O*r;m.fillStyle=f.color,m.fillRect(0,b,v.width,w),b+=w}}m.globalCompositeOperation="destination-in",m.fillStyle="white",m.beginPath(),m.arc(p,l,I,0,Math.PI*2),m.arc(p,l,C,Math.PI*2,0,!0),m.fill(),o.drawImage(v,-B/2,0)}else{o.save(),o.beginPath();const h=t.imageOffsetPx?.x??0,$=t.imageOffsetPx?.y??0;o.arc(l+h,l+$,V,0,Math.PI*2),o.closePath(),o.clip();const T=M.width,S=M.height,z=V*2,R=Math.max(z/T,z/S),Q=T*R,P=S*R,q=c/2+h,B=r/2+$;if(o.drawImage(M,q-Q/2,B-P/2,Q,P),o.restore(),t.onProgress?.(.5),t.borderImageBitmap&&g!=="cutout"){const v=Math.max(1,Math.round(I-C)),m=(C+I)/2,b=Math.max(2,Math.round(2*Math.PI*m)),f=v;try{const d=new OffscreenCanvas(b,f),w=d.getContext("2d"),A=t.borderImageBitmap.width,W=t.borderImageBitmap.height,Y=Math.max(b/A,f/W),j=Math.round(A*Y),X=Math.round(W*Y),at=Math.round((b-j)/2),nt=Math.round((f-X)/2);w.clearRect(0,0,b,f),w.drawImage(t.borderImageBitmap,0,0,A,W,at,nt,j,X);const ot=await createImageBitmap(d),st=t.segmentRotation!==void 0?t.segmentRotation*Math.PI/180:0,rt=-Math.PI/2+st;tt(o,l,C,I,ot,rt,"normal")}catch{try{tt(o,l,C,I,t.borderImageBitmap)}catch{o.save(),o.globalAlpha=.64,Z(o,l,C,I,k,O),o.restore()}}}else if(u==="concentric")Z(o,l,C,I,k,O);else{const v=t.segmentRotation!==void 0?t.segmentRotation*Math.PI/180:0;let m=-Math.PI/2+v;for(const p of k){const b=p.weight/O,f=Math.PI*2*b,d=m+f;Mt(o,l,C,I,m,d,p.color),m=d}}}s&&n.mark("renderComplete"),t.onProgress?.(.8),t.outerStroke&&(o.beginPath(),o.arc(c/2,r/2,I,0,Math.PI*2),o.strokeStyle=t.outerStroke.color,o.lineWidth=t.outerStroke.widthPx,o.stroke());const G=t.pngQuality??.92,L=await ft(N,"image/png",G),F=L.size,y=(F/1024).toFixed(2);if(s){n.mark("exportComplete");const h=n.complete({width:e.width,height:e.height},{width:c,height:r},x,D);return t.onProgress?.(1),{blob:L,sizeBytes:F,sizeKB:y,metrics:h}}return t.onProgress?.(1),{blob:L,sizeBytes:F,sizeKB:y}}function Z(e,a,t,n,s,i){const M=n-t;let x=n;for(const D of s){const c=D.weight/i*M,r=Math.max(t,x-c);if(e.beginPath(),e.arc(a,a,x,0,Math.PI*2),e.arc(a,a,r,Math.PI*2,0,!0),e.closePath(),e.fillStyle=D.color,e.fill(),x=r,x<=t+.5)break}x>t+.5&&(e.beginPath(),e.arc(a,a,x,0,Math.PI*2),e.arc(a,a,t,Math.PI*2,0,!0),e.closePath(),e.fillStyle=s[s.length-1]?.color??"#000000",e.fill())}function Mt(e,a,t,n,s,i,M){e.beginPath(),e.arc(a,a,n,s,i),e.arc(a,a,t,i,s,!0),e.closePath(),e.fillStyle=M,e.fill()}function xt(e,a,t){return Math.min(Math.max(e,a),t)}function tt(e,a,t,n,s,i=0,M="normal"){const x=n-t;if(x<=0)return;const D=(t+n)/2,E=Math.max(1,Math.round(2*Math.PI*D)),c=Math.max(1,E),r=Math.max(1,Math.round(x)),H=new OffscreenCanvas(c,r).getContext("2d"),K=s.width,N=s.height,o=Math.max(c/K,r/N),l=Math.round(K*o),I=Math.round(N*o),C=Math.round((c-l)/2),U=Math.round((r-I)/2);H.clearRect(0,0,c,r),H.drawImage(s,0,0,K,N,C,U,l,I);const _=H.getImageData(0,0,c,r).data,k=Math.floor(a-n),O=Math.floor(a-n),g=Math.ceil(n*2),u=g,G=new OffscreenCanvas(g,u),L=G.getContext("2d"),F=L.createImageData(g,u),y=F.data,h=Math.PI*2,$=1/h;for(let P=0;P<u;P++){const B=O+P+.5-a;for(let v=0;v<g;v++){const p=k+v+.5-a,b=p*p+B*B,f=Math.sqrt(b),d=(P*g+v)*4;if(f<t||f>n){y[d+0]=0,y[d+1]=0,y[d+2]=0,y[d+3]=0;continue}let w=Math.atan2(B,p);for(w-=i;w<0;)w+=h;for(;w>=h;)w-=h;const A=w*$*c,W=(f-t)/x*r,Y=Math.min(c-1,Math.max(0,Math.floor(A))),X=(Math.min(r-1,Math.max(0,Math.floor(W)))*c+Y)*4;y[d+0]=_[X+0],y[d+1]=_[X+1],y[d+2]=_[X+2],y[d+3]=_[X+3]}}if(L.putImageData(F,0,0),M==="normal"){e.save(),e.drawImage(G,k,O),e.restore();return}const T=new OffscreenCanvas(g,u),S=T.getContext("2d");S.clearRect(0,0,g,u),S.drawImage(e.canvas,k,O,g,u,0,0,g,u);const z=S.getImageData(0,0,g,u),R=z.data,Q=L.getImageData(0,0,g,u).data;for(let P=0;P<R.length;P+=4)Q[P+3]>8&&(R[P+3]=0);S.putImageData(z,0,0),e.save(),e.drawImage(T,k,O),e.restore()}export{It as r};
