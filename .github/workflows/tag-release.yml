name: Tag Release

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.local/**'

permissions:
  contents: write

jobs:
  tag-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.9.15
        with:
          versionSpec: '5.x'

      - name: Calculate version with GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.9.15

      - name: Determine if tag should be created
        id: version
        run: |
          CURRENT_MAJOR="${{ steps.gitversion.outputs.major }}"
          CURRENT_MINOR="${{ steps.gitversion.outputs.minor }}"
          CURRENT_PATCH="${{ steps.gitversion.outputs.patch }}"
          FULL_VERSION="${{ steps.gitversion.outputs.fullSemVer }}"
          
          # Get latest tag to compare
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            # No tag exists, create initial tag
            NEW_TAG="v${CURRENT_MAJOR}.${CURRENT_MINOR}.${CURRENT_PATCH}"
            BUMP_TYPE="initial"
            echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
            echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Parse latest tag
          if [[ $LATEST_TAG =~ v([0-9]+)\.([0-9]+)(?:\.([0-9]+))? ]]; then
            TAG_MAJOR=${BASH_REMATCH[1]}
            TAG_MINOR=${BASH_REMATCH[2]}
            TAG_PATCH=${BASH_REMATCH[3]:-0}
          else
            TAG_MAJOR=0
            TAG_MINOR=0
            TAG_PATCH=0
          fi
          
          # Determine bump type by comparing versions
          BUMP_TYPE="none"
          if [ "$CURRENT_MAJOR" -gt "$TAG_MAJOR" ]; then
            BUMP_TYPE="major"
          elif [ "$CURRENT_MAJOR" -eq "$TAG_MAJOR" ] && [ "$CURRENT_MINOR" -gt "$TAG_MINOR" ]; then
            BUMP_TYPE="minor"
          fi
          
          # Only create tag if there's a major or minor bump
          if [ "$BUMP_TYPE" = "none" ]; then
            echo "No major or minor version bump detected. Skipping tag creation."
            echo "bump_type=none" >> $GITHUB_OUTPUT
            echo "new_tag=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create full version tag
          NEW_TAG="v${CURRENT_MAJOR}.${CURRENT_MINOR}.${CURRENT_PATCH}"
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "Calculated: $NEW_TAG ($BUMP_TYPE bump from $LATEST_TAG)"

      - name: Check if tag already exists
        id: check-tag
        run: |
          NEW_TAG="${{ steps.version.outputs.new_tag }}"
          if [ -z "$NEW_TAG" ]; then
            echo "exists=skip" >> $GITHUB_OUTPUT
            echo "No tag to check (no version bump needed)"
          elif git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $NEW_TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag $NEW_TAG does not exist, will create"
          fi

      - name: Create and push tag
        if: steps.check-tag.outputs.exists == 'false' && steps.version.outputs.new_tag != ''
        run: |
          NEW_TAG="${{ steps.version.outputs.new_tag }}"
          BUMP_TYPE="${{ steps.version.outputs.bump_type }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG ($BUMP_TYPE bump)"
          git push origin "$NEW_TAG"
          
          echo "Created and pushed tag: $NEW_TAG"

      - name: Summary
        run: |
          BUMP_TYPE="${{ steps.version.outputs.bump_type }}"
          NEW_TAG="${{ steps.version.outputs.new_tag }}"
          EXISTS="${{ steps.check-tag.outputs.exists }}"
          
          if [ "$BUMP_TYPE" = "none" ] || [ -z "$NEW_TAG" ]; then
            echo "### ℹ️ No Version Bump" >> $GITHUB_STEP_SUMMARY
            echo "No major or minor version bump detected in commits." >> $GITHUB_STEP_SUMMARY
            echo "No tag created." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Patch versions are calculated automatically by GitVersion." >> $GITHUB_STEP_SUMMARY
          elif [ "$EXISTS" = "false" ]; then
            echo "### ✅ Tag Created" >> $GITHUB_STEP_SUMMARY
            echo "**Tag:** \`$NEW_TAG\`" >> $GITHUB_STEP_SUMMARY
            echo "**Bump Type:** $BUMP_TYPE" >> $GITHUB_STEP_SUMMARY
            echo "**Full SemVer:** \`${{ steps.gitversion.outputs.fullSemVer }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ℹ️ Tag Already Exists" >> $GITHUB_STEP_SUMMARY
            echo "**Tag:** \`$NEW_TAG\`" >> $GITHUB_STEP_SUMMARY
            echo "No new tag created (tag already exists)" >> $GITHUB_STEP_SUMMARY
          fi
